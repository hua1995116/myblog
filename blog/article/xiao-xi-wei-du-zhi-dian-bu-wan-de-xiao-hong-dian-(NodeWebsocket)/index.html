<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="description" content="æ¶ˆæ¯æœªè¯»ä¹‹ç‚¹ä¸å®Œçš„å°çº¢ç‚¹(Node+Websocket)">
  <title>æ¶ˆæ¯æœªè¯»ä¹‹ç‚¹ä¸å®Œçš„å°çº¢ç‚¹(Node+Websocket)</title>
  <script src='https://s3.qiufengh.com/blog/nprogress@0.2.0.js'></script>
  <link rel='stylesheet' href='https://s3.qiufengh.com/blog/nprogress@0.2.0.css' />
  <link rel="stylesheet" type="text/css" href="/css/style.css">
  <link rel="stylesheet" type="text/css" href="/css/github-markdown.css">
  <link rel="stylesheet" type="text/css" href="/css/prism.css">
  <link rel="stylesheet" type="text/css" href="/css/blog_index.css">
  <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
  <!-- Hotjar Tracking Code for https://blog.qiufengh.com -->
  <script>
    (function(h, o, t, j, a, r) {
      h.hj = h.hj || function() {
        (h.hj.q = h.hj.q || []).push(arguments)
      };
      h._hjSettings = {
        hjid: 1650125,
        hjsv: 6
      };
      a = o.getElementsByTagName('head')[0];
      r = o.createElement('script');
      r.async = 1;
      r.src = t + h._hjSettings.hjid + j + h._hjSettings.hjsv;
      a.appendChild(r);
    })(window, document, 'https://static.hotjar.com/c/hotjar-', '.js?sv=');
  </script>
</head>

<body scroll="no">
  <header>
    <nav class="nav">
      <ul class="title clear">
        <a href="/index.html">
          Home
        </a>
        <a href="/blog/tag">
          Tags
        </a>
        <a href="https://juejin.im/user/5964cb3a6fb9a06bb0194421">
          <span class="juejin blog-icon"></span>
        </a>
        <a href="https://github.com/hua1995116/">
          <span class="github blog-icon"></span>
        </a>
        <a href="/blog" class="cta">
          Blog
        </a>
      </ul>
    </nav>
  </header>
  <div class="body-content clear">
    <section>
      <div class="detail-content">
        <div class="header">
          <h1>
            æ¶ˆæ¯æœªè¯»ä¹‹ç‚¹ä¸å®Œçš„å°çº¢ç‚¹(Node+Websocket)
          </h1>
        </div>
        <div class="timer">
          2018-11-09
        </div>
        <div class="readers">
          é˜…è¯»é‡<span id="busuanzi_value_page_pv"></span>
        </div>
        <div class="type clear">
          <span class="span_button"> websocket
          </span>
        </div>
        <div class="content markdown-body">
          <h1 id="-">å‰è¨€</h1>
          <p><a href="https://github.com/hua1995116/webchat">https://github.com/hua1995116/webchat</a> </p>
          <p>è¿™ä¸ªé¡¹ç›®æœ¬æ¥æ˜¯æˆ‘å­¦ç”Ÿæ—¶ä»£ä¸ºäº†æ‰¾å·¥ä½œçš„ä¸€ä¸ªç»ƒæ‰‹é¡¹ç›®ï¼Œä½†æ˜¯æ²¡æƒ³åˆ°å—åˆ°äº†å¾ˆå¤šçš„å…³æ³¨ï¼Œstarä¹Ÿå¿«è¦ç ´Käº†ï¼Œè¿™ä¹Ÿæ¿€åŠ±ç€æˆ‘ä¸æ–­å»å®Œå–„ä»–ï¼Œä¸€æ–¹é¢æ˜¯å¾—å¯¹å¾—èµ·å…³æ³¨å­¦ä¹ çš„äººï¼Œå¦ä¸€æ–¹é¢ä¹Ÿæ˜¯æƒ³è®©è‡ªå·±èƒ½è¿‡é€šè¿‡æ…¢æ…¢å®Œå–„ä¸€ä¸ªé¡¹ç›®æ¥è®©è‡ªå·±æé«˜ã€‚</p>
          <p><img src="https://s3.qiufengh.com/blog/1568533450654.jpg" alt=""></p>
          <p>ä»Šå¤©ç»™å¤§å®¶å¸¦æ¥çš„æ˜¯åŸºäºWebsocket+Node+Redisæœªè¯»æ¶ˆæ¯åŠŸèƒ½ï¼Œå¯èƒ½æ›´åŠ åå‘äºå®æˆ˜æ–¹å‘ï¼Œéœ€è¦å¯¹Websocketå’ŒNodeæœ‰ä¸€äº›äº†è§£ï¼Œå½“ç„¶ä¸äº†è§£ä¹Ÿå¯ä»¥çœ‹çœ‹æ•ˆæœï¼Œæ•ˆæœé“¾æ¥ï¼ˆ <a href="https://www.qiufengh.com/">https://www.qiufengh.com/</a> ï¼‰è¯´ä¸å®šä¼šæ¿€èµ·ä½ å­¦ä¹ çš„åŠ¨åŠ›~</p>
          <p>ä¸‹é¢æˆ‘é€šè¿‡è‡ªå·±æ€è€ƒçš„æ–¹å¼æ¥è¿›è¡Œè®²è§£ï¼Œä»£ç å¯èƒ½è®²çš„ä¸å¤šï¼Œä½†æ˜¯æ ¸å¿ƒé€»è¾‘éƒ½è¿›è¡Œäº†è®²è§£ï¼Œä¸Šé¢ä¹Ÿæœ‰githubåœ°å€ï¼Œæœ‰å…´è¶£çš„å¯ä»¥è¿›è¡Œè¯¦ç»†åœ°æŸ¥çœ‹ã€‚è‡ªå·±çš„ideaæˆ–å¤šæˆ–å°‘ä¼šæœ‰ä¸€äº›ä¸æˆç†Ÿï¼Œä½†æ˜¯æˆ‘è¿˜æ˜¯åšç€è„¸çš®å‡ºæ¥æŠ›å¤´éœ²è„¸ï¼Œå¦‚æœæœ‰ä»€ä¹ˆå»ºè®®è¿˜è¯·å¤§å®¶å¤šå¤šæå‡ºï¼Œèƒ½è®©æˆ‘æ›´åŠ å®Œå–„è¿™ä¸ªä½œå“ã€‚</p>
          <h1 id="-">è®¾è®¡</h1>
          <p>é¦–å…ˆå¯¹äºæ¶ˆæ¯æœªè¯»ï¼Œå¤§å®¶éƒ½å¾ˆç†Ÿæ‚‰ï¼Œå°±æ˜¯å„ç§èŠå¤©çš„æ—¶å€™ï¼Œå‡ºç°çš„çº¢ç‚¹ç‚¹ï¼Œä¸”æ˜¯å¼ºè¿«ç—‡è€…å¿…é¡»æ¸…ç†çš„ä¸€ä¸ªå°ç‚¹ç‚¹ï¼Œå¦‚ğŸ‘‡æ‰€ç¤ºã€‚æˆ‘ä¼šå¸¦å¤§å®¶å®ç°ä¸€ä¸ªè¿™æ ·çš„åŠŸèƒ½ã€‚
            <img src="https://s3.qiufengh.com/blog/1568533450630.jpg" alt=""></p>
          <p>ç”±äºä¸€å¯¹ä¸€çš„æ–¹å¼æ›´åŠ ç®€å•ï¼Œæˆ‘ç°åœ¨åªè€ƒè™‘å¤šå¯¹å¤šçš„æƒ…å†µï¼Œä¹Ÿå°±æ˜¯åœ¨ä¸€ä¸ªæˆ¿é—´ï¼ˆä¹Ÿå¯ä»¥ç§°ä¸ºç¾¤ç»„ï¼Œåé¢éƒ½ä»¥æˆ¿é—´ç§°å‘¼ï¼‰ä¸­çš„æœªè¯»æ¶ˆæ¯ï¼Œé‚£ä¹ˆè®¾è®¡è¿™æ ·çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œé¦–ç›¸æˆ‘å°†å®ƒåˆ†æˆäº†3ç§ç”¨æˆ·ã€‚</p>
          <ul>
            <li>ç¦»çº¿ç”¨æˆ·</li>
            <li>åœ¨çº¿ç”¨æˆ·</li>
            <li>åœ¨çº¿ç”¨æˆ·ä¸”è¿›å…¥ç¾¤ç»„çš„ç”¨æˆ·</li>
          </ul>
          <h3 id="-">ç¦»çº¿ç”¨æˆ·</h3>
          <p>è¿™ç§åœºæ™¯å°±ç›¸å½“äºæˆ‘ä»¬é€€å‡ºå¾®ä¿¡ï¼Œä½†æ˜¯åˆ«äººåœ¨æˆ¿é—´é‡Œå‘çš„æ¶ˆæ¯ï¼Œå½“æˆ‘ä»¬å†æ¬¡æ‰“å¼€çš„æ—¶å€™ä¾ç„¶èƒ½å¤Ÿçœ‹åˆ°æˆ¿é—´å¢é•¿çš„æœªè¯»æ¶ˆæ¯ã€‚</p>
          <h3 id="-">åœ¨çº¿ç”¨æˆ·</h3>
          <p>è¿™ç§åœºæ™¯å°±æ˜¯ç›¸å½“æˆ‘ä»¬åœç•™åœ¨èŠå¤©åˆ—è¡¨é¡µé¢ï¼Œå½“ä»–äººåœ¨æˆ¿é—´ä¸­å‘é€æ¶ˆæ¯ï¼Œæˆ‘ä»¬èƒ½å¤Ÿå®æ—¶çš„çœ‹åˆ°æœªè¯»æ¶ˆæ¯çš„æ¡æ•°åœ¨å¢é•¿ã€‚</p>
          <p>åœºæ™¯ç¤ºä¾‹ã€‚
            <img src="https://user-gold-cdn.xitu.io/2018/11/19/16729eb68b18a543?w=2000&h=2000&f=png&s=231925" style="width:500px;text-align: center"></p>
          <h3 id="-">åœ¨çº¿ç”¨æˆ·ä¸”åœ¨æˆ¿é—´çš„ç”¨æˆ·</h3>
          <p>è¿™ç§åœºæ™¯å…¶å®å°±æ¯”è¾ƒæ™®é€šäº†ï¼Œå½“åˆ«äººå‘é€æ–°çš„æ¶ˆæ¯ï¼Œæˆ‘ä»¬å°±èƒ½å®æ—¶çœ‹åˆ°ï¼Œæ­¤æ—¶æ˜¯ä¸éœ€è¦æ ‡è®°æœªè¯»æ¶ˆæ¯çš„ã€‚</p>
          <p>åœºæ™¯ç¤ºä¾‹ã€‚
            <img src="https://user-gold-cdn.xitu.io/2018/11/19/16729ebe4cc2ff41?w=2000&h=2000&f=png&s=500000" style="width:500px;text-align: center"></p>
          <h1 id="-">æµç¨‹å›¾</h1>
          <p>ä¸»è¦æµç¨‹å¯ä»¥ç®€åŒ–ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼Œåˆ†åˆ«ä¸ºç”¨æˆ·ï¼Œæ¨é€åŠŸèƒ½ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ã€‚</p>
          <p>ç”¨æˆ·å¯ä»¥æ˜¯æ¶ˆæ¯æä¾›è€…ä¹Ÿå¯ä»¥æ˜¯æ¶ˆæ¯æ¥å—è€…ã€‚ä»¥ä¸‹å°±æ˜¯è¿™ä¸ªè¿‡ç¨‹ã€‚
            <img src="https://s3.qiufengh.com/blog/1568533450629.png" alt="image"></p>
          <p>å½“ç„¶åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ¶‰åŠæ¯”è¾ƒå¤æ‚çš„æ¶ˆæ¯çš„å­˜å‚¨ï¼Œå¦‚ä½•æ¨é€ï¼Œè·å–ï¼ŒåŒæ­¥ç­‰é—®é¢˜ï¼Œä¸‹é¢å°±æ˜¯å¯¹è¿™ä¸ªè¿‡ç¨‹è¿›è¡Œè¯¦ç»†çš„æè¿°</p>
          <p><img src="https://s3.qiufengh.com/blog/1568533450696.png" alt="image"></p>
          <p><strong>å›¾ä¸Šçš„æµç¨‹è§£é‡Š</strong></p>
          <p>A. å­˜å‚¨åœ¨Nodeç¼“å­˜ä¸­çš„æˆ¿é—´ç”¨æˆ·åˆ—è¡¨ï¼ˆæ­¤å¤„ä¿¡æ¯ä¹Ÿå¯ä»¥å­˜åœ¨Redisä¸­ï¼‰</p>
          <p>B. å­˜å‚¨åœ¨Redisä¸­çš„æœªè¯»æ¶ˆæ¯åˆ—è¡¨</p>
          <p>C. å­˜å‚¨åœ¨MongoDBä¸­çš„æœªè¯»æ¶ˆæ¯åˆ—è¡¨</p>
          <ol>
            <li>ç”¨æˆ·1è¿›å…¥é¦–é¡µã€‚</li>
            <li>ç”¨æˆ·1è¿›å…¥æˆ¿é—´ï¼Œé‡ç½®ç”¨æˆ·åœ¨æˆ¿é—´1çš„æœªè¯»æ¶ˆæ¯ï¼Œè§¦å‘æ›´æ–°æ¨¡å—å»æ›´æ–°Bæœªè¯»æ¶ˆæ¯åˆ—è¡¨ã€‚</li>
            <li>ç”¨æˆ·1å‘å‘æˆ¿é—´Bä¸­å‘é€äº†ä¸€æ¡æ¶ˆæ¯ã€‚</li>
            <li>åç«¯éœ€è¦å»è·å–æˆ¿é—´ç”¨æˆ·åˆ—è¡¨ï¼Œåˆ¤æ–­ç”¨æˆ·æ˜¯å¦åœ¨æˆ¿é—´ï¼Ÿ</li>
            <li>æ˜¯ï¼Œå› ä¸ºåœ¨æˆ¿é—´ä¸­çš„ç”¨æˆ·å·²ç»è¯»å–äº†æœ€æ–°æ¶ˆæ¯ï¼Œä¸éœ€è¦è¿›è¡Œè®¡æ•°ã€‚</li>
            <li>å¦ï¼Œè‹¥ç”¨æˆ·ä¸åœ¨æˆ¿é—´ä¸­ï¼Œæ›´æ–°å…¶çš„æœªè¯»æ¶ˆæ¯è®¡æ•°</li>
            <li>ä»ç¼“å­˜ä¸­è·å–ç”¨æˆ·çš„æ¶ˆæ¯è¿›è¡Œåˆ†å‘ã€‚</li>
            <li>ç”¨æˆ·2ç™»å½•æˆ‘ä»¬çš„é¡¹ç›®ï¼Œä»ç¦»çº¿ç”¨æˆ·å˜æˆäº†åœ¨çº¿ç”¨æˆ·ã€‚</li>
            <li>ç”¨æˆ·2ç™»å½•æ—¶ï¼Œè§¦å‘æŸ¥è¯¢æ¨¡å—ï¼Œå»è·å–å…¶å½“å‰åœ¨å„ä¸ªæˆ¿é—´æœªè¯»æ¶ˆæ¯æƒ…å†µã€‚</li>
            <li>æŸ¥è¯¢æ¨¡å—å»æŸ¥è¯¢Redisä¸­çš„æœªè¯»æ¶ˆæ¯ï¼Œè‹¥Redisä¸­æ²¡æœ‰æ•°æ®ï¼Œä¼šç»§ç»­å‘æ•°æ®åº“ä¸­æŸ¥è¯¢ï¼Œè‹¥æ²¡æœ‰åˆ™è¿”å›0ç»™ç”¨æˆ·ã€‚</li>
            <li>Redisç¼“å­˜å°†ä¼šæ¯åˆ†é’Ÿå’Œæ•°æ®åº“åŒæ­¥ä¸€æ¬¡ï¼Œä¿è¯æ•°æ®çš„æŒä¹…åŒ–ã€‚</li>
          </ol>
          <h1 id="-">ç¯å¢ƒ</h1>
          <ul>
            <li>
              <p>Node: 8.5.0 +</p>
            </li>
            <li>
              <p>Npm: 5.3.0 +</p>
            </li>
            <li>
              <p>MongoDB</p>
            </li>
            <li>
              <p>Redis</p>
            </li>
          </ul>
          <h2 id="-redis-">ä¸ºä»€ä¹ˆæ˜¯redis ï¼Ÿ</h2>
          <h3 id="-">ä»‹ç»</h3>
          <p>Redis æ˜¯äº’è”ç½‘æŠ€æœ¯é¢†åŸŸä½¿ç”¨æœ€ä¸ºå¹¿æ³›çš„å­˜å‚¨ä¸­é—´ä»¶ï¼Œå®ƒæ˜¯ã€ŒRemote Dictionary Serviceã€çš„é¦–å­—æ¯ç¼©å†™ï¼Œæ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„key-valueæ•°æ®åº“ã€‚å…·æœ‰æ€§èƒ½æé«˜ï¼Œä¸°å¯Œçš„æ•°æ®ç±»å‹ï¼ŒåŸå­ï¼Œä¸°å¯Œçš„ç‰¹æ€§ç­‰ä¼˜åŠ¿ã€‚</p>
          <p>redis å…·æœ‰ä»¥ä¸‹5ç§æ•°æ®ç»“æ„</p>
          <ul>
            <li>Stringâ€”â€”å­—ç¬¦ä¸²</li>
            <li>Hashâ€”â€”å­—å…¸</li>
            <li>Listâ€”â€”åˆ—è¡¨</li>
            <li>Setâ€”â€”é›†åˆ</li>
            <li>Sorted Setâ€”â€”æœ‰åºé›†åˆ</li>
          </ul>
          <p>æƒ³è¦æ·±å…¥äº†è§£è¿™5ç§å­˜å‚¨ç»“æ„å¯ä»¥æŸ¥çœ‹<a href="http://www.runoob.com/w3cnote/redis-use-scene.html">http://www.runoob.com/w3cnote/redis-use-scene.html</a></p>
          <h3 id="-">å®‰è£…</h3>
          <p><strong>windows</strong></p>
          <blockquote>
            <p><a href="http://www.cnblogs.com/jaign/articles/7920588.html">http://www.cnblogs.com/jaign/articles/7920588.html</a></p>
          </blockquote>
          <p><strong>mac</strong></p>
          <blockquote>
            <p>brew install redis</p>
          </blockquote>
          <p><strong>ubuntu</strong></p>
          <blockquote>
            <p>apt-get install redis</p>
          </blockquote>
          <p><strong>redhat</strong></p>
          <blockquote>
            <p>yum install redis</p>
          </blockquote>
          <p><strong>centos</strong></p>
          <blockquote>
            <p><a href="https://www.cnblogs.com/zuidongfeng/p/8032505.html">https://www.cnblogs.com/zuidongfeng/p/8032505.html</a></p>
          </blockquote>
          <p><strong>è¿è¡Œå®¢æˆ·ç«¯</strong></p>
          <blockquote>
            <p>redis-cli</p>
          </blockquote>
          <h3 id="-">å¯è§†åŒ–å·¥å…·å®‰è£…</h3>
          <p><strong>windows</strong></p>
          <blockquote>
            <p><a href="https://pan.baidu.com/s/1kU8sY3P">https://pan.baidu.com/s/1kU8sY3P</a></p>
          </blockquote>
          <p><strong>mac</strong></p>
          <blockquote>
            <p><a href="https://pan.baidu.com/s/10vpdhw7YfDD7G4yZCGtqQg">https://pan.baidu.com/s/10vpdhw7YfDD7G4yZCGtqQg</a></p>
          </blockquote>
          <p><strong>æºç ç¼–è¯‘</strong></p>
          <blockquote>
            <p><a href="http://docs.redisdesktop.com/en/latest/install/#build-from-source">http://docs.redisdesktop.com/en/latest/install/#build-from-source</a></p>
          </blockquote>
          <h3 id="-">é¡¹ç›®ä¸­çš„æ•°æ®ç»“æ„</h3>
          <p>åœ¨æœ¬é¡¹ç›®ä¸­æˆ‘ä»¬ç”¨String æ¥å­˜å‚¨ç”¨æˆ·çš„æœªè¯»æ¶ˆæ¯è®°å½•ï¼Œåˆ©ç”¨å…¶incrå‘½ä»¤æ¥è¿›è¡Œè‡ªå¢æ“ä½œã€‚åˆ©ç”¨Hashç»“æ„ æ¥å­˜å‚¨æˆ‘ä»¬websocketè¿æ¥æ—¶ç”¨æˆ·çš„socket-idã€‚</p>
          <p>ä¸Šé¢è¯´äº†è®¡æ•°åˆ©ç”¨Redisçš„Stirngæ•°æ®ç»“æ„,
            åœ¨Redis æˆ‘ä»¬çš„è®¡æ•°key-valueæ˜¯è¿™æ ·çš„ã€‚</p>
          <p>username-roomid - number</p>
          <p>ä¾‹å­: hua1995116-room1 - 1</p>
          <p>æˆ‘ä»¬çš„Socket-idåˆ™ä¸ºHashç»“æ„ã€‚</p>
          <ul>
            <li>socketId<ul>
                <li>username - socketid</li>
              </ul>
            </li>
          </ul>
          <p>ä¾‹å­:</p>
          <ul>
            <li>socketId<ul>
                <li>hua1995116 - En4ilYqDpk-P5_tzAAAG</li>
              </ul>
            </li>
          </ul>
          <h1 id="mongodb">MongoDB</h1>
          <p>æœ¬é¡¹ç›®ä¸€å¼€å§‹å°±ä½¿ç”¨äº†MongoDBï¼ŒNodeå¤©ç„¶æ­é…çš„MongoDBçš„ä¼˜åŠ¿ï¼Œè¿™é‡Œå°±ä¸å†è¿›è¡Œè®²è§£ï¼ŒNodeæ“ä½œMongoDBçš„æ¨¡å—å«åšmongooseï¼Œå…·ä½“çš„å‚æ•°æ–¹æ³•ï¼Œå¯ä»¥æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ã€‚</p>
          <p><a href="https://mongoosejs.com/docs/4.x/index.html">https://mongoosejs.com/docs/4.x/index.html</a></p>
          <p>MongoDBä¸‹è½½åœ°å€</p>
          <p><a href="https://www.mongodb.com/download-center/community">https://www.mongodb.com/download-center/community</a></p>
          <p>å¯è§†åŒ–ä¸‹è½½åœ°å€</p>
          <p><a href="https://github.com/mrvautin/adminMongo">https://github.com/mrvautin/adminMongo</a></p>
          <h1 id="websocket-node-">websocket + node å®ç°</h1>
          <p>ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸€å¼€å§‹çš„3ç§ç”¨æˆ·çš„åœºæ™¯æ¥å…·ä½“è¯´æ˜å®ç°çš„ä»£ç ã€‚</p>
          <h3 id="-">ç¦»çº¿ç”¨æˆ·å˜æˆåœ¨çº¿ç”¨æˆ·</h3>
          <p><img src="https://s3.qiufengh.com/blog/1568533450632.png" alt="image"></p>
          <p>å®¢æˆ·ç«¯åœ¨ç™»å½•æ—¶ä¼šå‘é€ä¸€ä¸ªloginäº‹ä»¶ï¼Œä»¥ä¸‹æ˜¯åç«¯é€»è¾‘ã€‚</p>
          <pre><code class="lang-Javascript">// å»ºç«‹è¿æ¥
socket.on(&#39;login&#39;,async (user) =&gt; {
    console.log(&#39;socket login!&#39;);
    const {name} = user;
    if (!name) {
      return;
    }
    socket.name = name;
    const roomInfo = {};
    // åˆå§‹åŒ–socketId
    await updatehCache(&#39;socketId&#39;, name, socket.id);

    for(let i = 0; i &lt; roomList.length; i++) {
      const roomid = roomList[i];
      const key = `${name}-${roomid}`;
      // å¾ªç¯æ‰€æœ‰æˆ¿é—´
      const res = await findOne({username: key});
      const count = await getCacheById(key);

      if(res) {
        // æ•°æ®åº“æŸ¥æ•°æ®ï¼Œ è‹¥ç¼“å­˜ä¸­æ²¡æœ‰æ•°æ®ï¼Œæ›´æ–°ç¼“å­˜
        if(+count === 0) {
          updateCache(key, res.roomInfo);
        }
        roomInfo[roomid] = res.roomInfo;
      } else {
        roomInfo[roomid] = +count;
      }
    }
    // é€šçŸ¥è‡ªå·±æœ‰å¤šå°‘æ¡æœªè¯»æ¶ˆæ¯
    socket.emit(&#39;count&#39;, roomInfo);

});
</code></pre>
          <p>ç”¨æˆ·ä»ç¦»çº¿å˜æˆåœ¨çº¿çŠ¶æ€ï¼Œå»ºç«‹socketè¿æ¥æ—¶å€™ï¼Œä¼šå‘é€ä¸€ä¸ªloginäº‹ä»¶, æœåŠ¡ç«¯å°±ä¼šå»æŸ¥è¯¢å½“å‰ç”¨æˆ·çš„æœªè¯»æ¶ˆæ¯æƒ…å†µï¼Œä»MongoDBå’ŒRedisåˆ†åˆ«æŸ¥è¯¢ï¼Œè‹¥Redisä¸­æ²¡æœ‰æ•°æ®ï¼Œåˆ™åƒæ•°æ®åº“æŸ¥è¯¢ã€‚</p>
          <h3 id="-">åœ¨çº¿ç”¨æˆ·è¿›å…¥æˆ¿é—´</h3>
          <p><img src="https://s3.qiufengh.com/blog/1568533451348.png" alt="image"></p>
          <p>å®¢æˆ·ç«¯åœ¨åŠ å…¥æˆ¿é—´è¯´è¯ä¼šå‘é€ä¸€ä¸ªroomäº‹ä»¶ï¼Œä»¥ä¸‹æ˜¯åç«¯é€»è¾‘</p>
          <pre><code class="lang-Javascript">// åŠ å…¥æˆ¿é—´
socket.on(&#39;room&#39;, async (user) =&gt; {
    console.log(&#39;socket add room!&#39;);
    const {name, roomid} = user;
    if (!name || !roomid) {
      return;
    }
    socket.name = name;
    socket.roomid = roomid;

    if (!users[roomid]) {
      users[roomid] = {};
    }
    // åˆå§‹åŒ–user
    users[roomid][name] = Object.assign({}, {
      socketid: socket.id
    }, user); 

    // åˆå§‹åŒ–user
    const key = `${name}-${roomid}`;
    await updatehCache(&#39;socketId&#39;, name, socket.id);

    // è¿›å…¥æˆ¿é—´é»˜è®¤ç½®ç©ºï¼Œè¡¨ç¤ºå…¨éƒ¨å·²è¯»
    await resetCacheById(key);
    // è¿›è¡Œä¼šè¯
    socket.join(roomid);

    const onlineUsers = {};
    for(let item in users[roomid]) {
      onlineUsers[item] = {};
      onlineUsers[item].src = users[roomid][item].src;
    }
    io.to(roomid).emit(&#39;room&#39;, onlineUsers);
    global.logger.info(`${name} åŠ å…¥äº† ${roomid}`);
});
</code></pre>
          <p>æœåŠ¡ç«¯æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„roomäº‹ä»¶ï¼Œæ¥é‡ç½®è¯¥ç”¨æˆ·æˆ¿é—´å†…çš„æœªè¯»æ¶ˆæ¯ï¼Œå¹¶ä¸”è¯¥ç”¨æˆ·åŠ å…¥æˆ¿é—´åˆ—è¡¨ã€‚</p>
          <h3 id="-">åœ¨æˆ¿é—´ä¸­çš„ç”¨æˆ·å‘é€æ¶ˆæ¯</h3>
          <p><img src="https://s3.qiufengh.com/blog/1568533450721.png" alt="image"></p>
          <p>å®¢æˆ·ç«¯åœ¨åŠ å…¥æˆ¿é—´è¯´è¯ä¼šå‘é€ä¸€ä¸ªmessageäº‹ä»¶ï¼Œä»¥ä¸‹æ˜¯åç«¯é€»è¾‘</p>
          <pre><code class="lang-Javascript">socket.on(&#39;message&#39;, async (msgObj) =&gt; {
    console.log(&#39;socket message!&#39;); 
    //å‘æ‰€æœ‰å®¢æˆ·ç«¯å¹¿æ’­å‘å¸ƒçš„æ¶ˆæ¯
    const {username, src, msg, img, roomid, time} = msgObj;
    if(!msg &amp;&amp; !img) {
      return;
    }
    ... // æ­¤å¤„ä¸ºå‘æ•°æ®åº“å­˜å…¥æ¶ˆæ¯
    const usersList = await gethAllCache(&#39;socketId&#39;);// æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨
    usersList.map(async item =&gt; {
      if(!users[roomid][item]) {  // åˆ¤æ–­æ˜¯å¦åœ¨æˆ¿é—´å†…
        const key = `${item}-${roomid}`
        await inrcCache(key);
        const socketid = await gethCacheById(&#39;socketId&#39;, item);
        const count = await getCacheById(key);
        const roomInfo = {};
        roomInfo[roomid] = count;
        socket.to(socketid).emit(&#39;count&#39;, roomInfo);
    }
}) 
</code></pre>
          <p>æ­¤æ­¥éª¤ç•¥å¾®å¤æ‚ï¼Œä¸»è¦æ˜¯æˆ¿é—´ä¸­çš„ç”¨æˆ·å‘é€æ¶ˆæ¯ï¼Œéœ€è¦ç»è¿‡åˆ¤æ–­ï¼Œå“ªéƒ¨åˆ†ç”¨æˆ·éœ€è¦è®¡æ•°ï¼Œå“ªéƒ¨åˆ†ç”¨æˆ·ä¸éœ€è¦è®¡æ•°ï¼Œä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œä¸åœ¨æˆ¿é—´å†…çš„ç”¨æˆ·éƒ½éœ€è¦è®¡æ•°ã€‚</p>
          <p>æ¥ä¸‹æ¥è¿˜éœ€è¦æ¨é€ï¼Œé‚£ä¹ˆå“ªäº›ç”¨æˆ·éœ€è¦å®æ—¶åœ°æ¨é€å‘¢ï¼Œå¯¹çš„ï¼Œå°±æ˜¯é‚£äº›åœ¨çº¿ç”¨æˆ·å¹¶ä¸”ä¸åœ¨æˆ¿é—´å†…çš„ç”¨æˆ·ã€‚å› æ­¤åœ¨è¿™é‡Œä¹Ÿéœ€è¦ä¸€ä¸ªåˆ¤æ–­ã€‚</p>
          <p>è¿™æ ·å°±å®Œç¾äº†ï¼Œèƒ½å¤Ÿç²¾ç¡®åœ°ç»™ç”¨æˆ·å¢åŠ è®¡æ•°ï¼Œå¹¶ä¸”ç²¾ç¡®åœ°æ¨é€ç»™éœ€è¦çš„ç”¨æˆ·ã€‚</p>
          <h1 id="-">åè®°</h1>
          <p>åœ¨çº¿æ¼”ç¤º: <a href="https://www.qiufengh.com/">https://www.qiufengh.com/</a></p>
          <p>githubåœ°å€: <a href="https://github.com/hua1995116/webchat">https://github.com/hua1995116/webchat</a></p>
          <p>å¦‚æœæœ‰ä»€ä¹ˆå»ºè®®æˆ–è€…ç–‘é—®å¯ä»¥åŠ å…¥å¾®ä¿¡ç¾¤è¿›è¡Œæ¢è®¨ã€‚</p>
          <p style="text-align:center">
            <img src="https://user-gold-cdn.xitu.io/2018/11/19/16729ed23f9be3a2?w=674&h=896&f=jpeg&s=64232" style="width:300px">
          </p>

          <h1 id="-">æ›´å¤šè¯·å…³æ³¨</h1>
          <p><img src="https://s3.qiufengh.com/blog/1568533450717.png" alt=""></p>

          <!-- <div class="view-cnt">ï¼ˆ111 äººå·²é˜…ï¼‰</div> -->
        </div>
        <div class="my-pay">
          <div class="my-pay-btn">èµèµ</div>
          <div class="my-pay-type clear">
            <div class="my-pay-alipay my-pay-div"></div>
            <div class="my-pay-weixin my-pay-div"></div>
          </div>
        </div>
        <div class="wechat-container">
          <p>æ¬¢è¿å…³æ³¨æˆ‘çš„å…¬ä¼—å·ï¼Œç§‹é£çš„ç¬”è®°ã€‚</p>
          <img src="https://s3.qiufengh.com/blog/1688055012ff10bc.jpg" alt="">
        </div>
      </div>

      <div id="container"></div>
    </section>

  </div>
  <div class="blog-bottom">
    <span id="busuanzi_container_site_pv">æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡</span>
  </div>
  <footer id="footer">
    <p class="small">Â© Copyright 2019 qiufenghua</p>
  </footer>
  <script type="text/javascript" src="/js/prism.js"></script>
  <script src="/js/axios.js"></script>
  <script src="/js/zooming.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      new Zooming({
        // options...
      }).listen('img')
    })
  </script>
  <script>
    NProgress.start();
    window.onload = function() {
      NProgress.done();
    }
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?f12dade0d0c1d020a5c06231f05b9f65";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
      var myPayBtn = document.querySelector('.my-pay-btn');
      var myPayType = document.querySelector('.my-pay-type');
      var btnShow = true;
      myPayBtn.addEventListener('click', function() {
        if (btnShow) {
          myPayType.style.display = 'block';
          btnShow = false;
        } else {
          myPayType.style.display = 'none';
          btnShow = true;
        }
      });
    })();
  </script>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
  <script>
    var gitment = new Gitment({
      id: location.href, // å¯é€‰ã€‚é»˜è®¤ä¸º location.href
      owner: 'hua1995116',
      repo: 'myblog',
      oauth: {
        client_id: '814dc8bc817d0a663020',
        client_secret: 'ae232061068d5844c3665b55e34d7d5edb220113',
      },
    })
    gitment.render('container')
  </script>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-112201282-3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
      dataLayer.push(arguments);
    }
    gtag('js', new Date());

    gtag('config', 'UA-112201282-3');
  </script>
</body>

</html>