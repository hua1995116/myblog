<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="description" content="首先我们为什么要做前端系统呢，先看下面这张表，可以很显然的看出，前端的性能对于产品的价值提升还是蛮有帮助的，但是这些信息如果我们能实时的采集到，并且实施以监控，让整个产品在产品线上一直保持高效的运作，这才是我们的目的。">
  <title>教你如何打造出一个前端可视化监控系统</title>
  <script src='https://unpkg.com/nprogress@0.2.0/nprogress.js'></script>
  <link rel='stylesheet' href='https://unpkg.com/nprogress@0.2.0/nprogress.css' />
  <link rel="stylesheet" type="text/css" href="/css/style.css">
  <link rel="stylesheet" type="text/css" href="/css/github-markdown.css">
  <link rel="stylesheet" type="text/css" href="/css/prism.css">
  <link rel="stylesheet" type="text/css" href="/css/blog_index.css">
  <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
</head>

<body scroll="no">
  <header>
    <nav class="nav">
      <ul class="title clear">
        <a href="/index.html">
          Home
        </a>
        <a href="/blog/tag">
          Tags
        </a>
        <a href="https://juejin.im/user/5964cb3a6fb9a06bb0194421">
          <span class="juejin blog-icon"></span>
        </a>
        <a href="https://github.com/hua1995116/">
          <span class="github blog-icon"></span>
        </a>
        <a href="/blog" class="cta">
          Blog
        </a>
      </ul>
    </nav>
  </header>
  <div class="body-content clear">
    <section>
      <div class="detail-content">
        <div class="header">
          <h1>
            教你如何打造出一个前端可视化监控系统
          </h1>
        </div>
        <div class="timer">
          2017-12-16
        </div>
        <div class="readers">
          阅读量<span id="busuanzi_value_page_pv"></span>
        </div>
        <div class="type clear">
          <span class="span_button"> 系统</span><span class="span_button">nodejs
          </span>
        </div>
        <div class="content markdown-body">
          <p>还记得在我上一家公司中，某一大佬做了一个监控系统，牛逼哄哄，挺想研究他到底是怎么搞出来的。当然我们也不是拍拍脑袋干活的人，总不能人家咋干我们就咋干。下面先就介绍下，这样的平台到底有啥好处。</p>
          <h1 id="-">背景</h1>
          <p>首先我们为什么要做前端系统呢，先看下面这张表，可以很显然的看出，前端的性能对于产品的价值提升还是蛮有帮助的，但是这些信息如果我们能实时的采集到，并且实施以监控，让整个产品在产品线上一直保持高效的运作，这才是我们的目的。</p>
          <table>
            <thead>
              <tr>
                <th>性能</th>
                <th>收益</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Google 延迟 <strong>400ms</strong></td>
                <td>搜索量下降 <strong>0.59%</strong></td>
              </tr>
              <tr>
                <td>Bing 延迟 <strong>2s</strong></td>
                <td>收入下降 <strong>4.3%</strong></td>
              </tr>
              <tr>
                <td>Yahoo 延迟 <strong>400ms</strong></td>
                <td>流量下降 <strong>5-9%</strong></td>
              </tr>
              <tr>
                <td>Mozilla 页面打开减少 <strong>2.2s</strong></td>
                <td>下载量提升 <strong>15.4%</strong></td>
              </tr>
              <tr>
                <td>Netflix 开启 Gzip</td>
                <td>性能提升 13.25% 带宽减少<strong>50%</strong></td>
              </tr>
            </tbody>
          </table>
          <p>其次，也有利于我们发布的产品，能够及时发现我们的错误。如果一个产品在新的迭代中，发生不可描述的错误。</p>
          <p><img src="https://s3.qiufengh.com/blog/1568533450466.gif" alt="https://s3.qiufengh.com/blog/1568533450466.gif"></p>
          <p>对！就是不可描述。我们总不可能等待用户的反馈投诉，到那个时候黄花菜都凉了。</p>
          <h1 id="-">开始</h1>
          <p>基于以上我们就开始搭建一个前端监<strong>简易</strong>控平台。(虽然现在市面上有很多这样的系统比如ELK,但是还是忍不住自己撸一个)</p>
          <p>只能是简易了。</p>
          <p><img src="https://s3.qiufengh.com/blog/1568533450488.gif" alt="https://s3.qiufengh.com/blog/1568533450488.gif"></p>
          <p>兄弟们原谅我，只能帮你们到这里了。</p>
          <p>接下来请看。</p>
          <p><img src="https://s3.qiufengh.com/blog/1568533450383.png" alt="https://s3.qiufengh.com/blog/1568533450383.png"></p>
          <p>以上是我们需要做的一些事情。</p>
          <h1 id="-">收集信息</h1>
          <p>要做监控系统，首先我们得有一个对象。我们监控的对象！对象！对象！对象。</p>
          <p>我在我的系统写了一个这样的页面，</p>
          <pre><code class="lang-html">&lt;body&gt;
    &lt;div&gt;2&lt;/div&gt;
    &lt;div&gt;2&lt;/div&gt;
    &lt;div&gt;2&lt;/div&gt;
    &lt;div&gt;2&lt;/div&gt;
    &lt;div&gt;2&lt;/div&gt;
    &lt;div&gt;2&lt;/div&gt; 
&lt;/body&gt;
</code></pre>
          <p>没错这就是我们要监控的页面。这个.....真不是我懒。</p>
          <p><img src="https://s3.qiufengh.com/blog/1568533450398.gif" alt="https://s3.qiufengh.com/blog/1568533450398.gif"></p>
          <p>然后接下来我一共设计了3块数据</p>
          <ul>
            <li>页面加载时间</li>
            <li>统计用户使用设备</li>
            <li>错误量的统计</li>
          </ul>
          <p>页面加载时间</p>
          <pre><code class="lang-javascript">window.logInfo = {};  //统计页面加载时间
window.logInfo.openTime = performance.timing.navigationStart;
window.logInfo.whiteScreenTime = +new Date() - window.logInfo.openTime;
document.addEventListener(&#39;DOMContentLoaded&#39;,function (event) {
  window.logInfo.readyTime = +new Date() - window.logInfo.openTime;
});
window.onload = function () {
  window.logInfo.allloadTime = +new Date() - window.logInfo.openTime;
  window.logInfo.nowTime = new Date().getTime();
  var timname = {
    whiteScreenTime: &#39;白屏时间&#39;,
    readyTime: &#39;用户可操作时间&#39;,
    allloadTime: &#39;总下载时间&#39;,
    mobile: &#39;使用设备&#39;,
    nowTime: &#39;时间&#39;,
  };
  var logStr = &#39;&#39;;
  for (var i in timname) {
    console.warn(timname[i] + &#39;:&#39; + window.logInfo[i] + &#39;ms&#39;);
    if (i === &#39;mobile&#39;) {
      logStr += &#39;&amp;&#39; + i + &#39;=&#39; + window.logInfo[i];
    } else {
      logStr += &#39;&amp;&#39; + i + &#39;=&#39; + window.logInfo[i];
    }

  }
  (new Image()).src = &#39;/action?&#39; + logStr;
};
</code></pre>
          <p>统计用户使用设备</p>
          <pre><code class="lang-javascript">window.logInfo.mobile = mobileType();
function mobileType() {
  var u = navigator.userAgent, app = navigator.appVersion;
  var type =  {// 移动终端浏览器版本信息
    ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
    iPad: u.indexOf(&#39;iPad&#39;) &gt; -1, //是否iPad
    android: u.indexOf(&#39;Android&#39;) &gt; -1 || u.indexOf(&#39;Linux&#39;) &gt; -1, //android终端或者uc浏览器
    iPhone: u.indexOf(&#39;iPhone&#39;) &gt; -1 || u.indexOf(&#39;Mac&#39;) &gt; -1, //是否为iPhone或者QQHD浏览器
    trident: u.indexOf(&#39;Trident&#39;) &gt; -1, //IE内核
    presto: u.indexOf(&#39;Presto&#39;) &gt; -1, //opera内核
    webKit: u.indexOf(&#39;AppleWebKit&#39;) &gt; -1, //苹果、谷歌内核
    gecko: u.indexOf(&#39;Gecko&#39;) &gt; -1 &amp;&amp; u.indexOf(&#39;KHTML&#39;) == -1, //火狐内核
    mobile: !!u.match(/AppleWebKit.*Mobile/i) || !!u.match(/MIDP|SymbianOS|NOKIA|SAMSUNG|LG|NEC|TCL|Alcatel|BIRD|DBTEL|Dopod|PHILIPS|HAIER|LENOVO|MOT-|Nokia|SonyEricsson|SIE-|Amoi|ZTE/), //是否为移动终端
    webApp: u.indexOf(&#39;Safari&#39;) == -1 //是否web应该程序，没有头部与底部
  };
  var lists = Object.keys(type);
  for(var i = 0; i &lt; lists.length; i++) {
    if(type[lists[i]]) {
      return lists[i];
    }
  }  
}
</code></pre>
          <p>错误量的统计</p>
          <pre><code class="lang-javascript">window.onload = function () {
        window.logInfo.allloadTime = +new Date() - window.logInfo.openTime;
        window.logInfo.nowTime = new Date().getTime();
        var timname = {
            whiteScreenTime: &#39;白屏时间&#39;,
            readyTime: &#39;用户可操作时间&#39;,
            allloadTime: &#39;总下载时间&#39;,
            mobile: &#39;使用设备&#39;,
            nowTime: &#39;时间&#39;,
        };
        var logStr = &#39;&#39;;
        for (var i in timname) {
            console.warn(timname[i] + &#39;:&#39; + window.logInfo[i] + &#39;ms&#39;);
            if (i === &#39;mobile&#39;) {
                logStr += &#39;&amp;&#39; + i + &#39;=&#39; + window.logInfo[i];
            } else {
                logStr += &#39;&amp;&#39; + i + &#39;=&#39; + window.logInfo[i];
            }

        }
        (new Image()).src = &#39;/action?&#39; + logStr;
    };

    var defaults = {
        msg:&#39;&#39;,  // 错误的具体信息
        url:&#39;&#39;,  // 错误所在的url
        line:&#39;&#39;, // 错误所在的行
        col:&#39;&#39;,  // 错误所在的列
        nowTime: &#39;&#39;,// 时间
    };
    window.onerror = function(msg,url,line,col,error) {
        col = col || (window.event &amp;&amp; window.event.errorCharacter) || 0;

        defaults.url = url;
        defaults.line = line;
        defaults.col =  col;
        defaults.nowTime = new Date().getTime();

        if (error &amp;&amp; error.stack){
            // 如果浏览器有堆栈信息，直接使用
            defaults.msg = error.stack.toString();

        }else if (arguments.callee){
            // 尝试通过callee拿堆栈信息
            var ext = [];
            var fn = arguments.callee.caller;
            var floor = 3;  
            while (fn &amp;&amp; (--floor&gt;0)) {
                ext.push(fn.toString());
                if (fn  === fn.caller) {
                    break;
                }
                fn = fn.caller;
            }
            ext = ext.join(&quot;,&quot;);
            defaults.msg = error.stack.toString();
        }
        var str = &#39;&#39;
        for(var i in defaults) {
            // console.log(i,defaults[i]);
            if(defaults[i] === null || defaults[i] === undefined) {
                defaults[i] = &#39;null&#39;; 
            }
            str += &#39;&amp;&#39;+ i + &#39;=&#39; + defaults[i].toString();
        }
        srt = str.replace(&#39;&amp;&#39;, &#39;&#39;).replace(&#39;\n&#39;,&#39;&#39;).replace(/\s/g, &#39;&#39;);
        (new Image()).src = &#39;/error?&#39; + srt;
    }
</code></pre>
          <p>以上就是收集数据的全部，通过发送/action请求或者是/error请求，这些都是可以自定义的，我讲的只是整个过程是如何实现的。</p>
          <p>然后通过我的的一个后台express.js把所有的请求处理并都记录下来，记录好后的数据是这样子的。</p>
          <pre><code class="lang-bash">user_ip=127.0.0.1&amp;whiteScreenTime=185&amp;readyTime=192&amp;allloadTime=208&amp;mobile=webKit&amp;nowTime=1513071388941
</code></pre>
          <h1 id="-">数据处理</h1>
          <p>这里我是通过自己写的一段脚本进行解析，parse.js，这里不具体讲解，看源码即可。我展现下解析好的数据。</p>
          <p>我以cvs的数据格式储存，因为后面图表的需要，我也支持json格式方式导出，只不过后面就需要你自己来配置可视化的界面了。</p>
          <p>数据是这样的。</p>
          <p>charts/csvData/2017-12-16time.csv</p>
          <pre><code class="lang-txt">时间,白屏时间,用户可操作时间,总下载时间
1513427051482,137,137,153
1513427065080,470,471,507
1513427080040,127,127,143
1513428714345,274,275,323
1513428733583,267,268,317
1513428743167,268,268,317
1513428754796,276,276,328
</code></pre>
          <h1 id="-">数据展示</h1>
          <p>这里我用的是<a href="https://www.hcharts.cn/">highcharts.js</a></p>
          <p>具体的配置我不进行讲解，可以自己到官网进行查看。</p>
          <p>下面是可视化的图表，显示的是每天各个时间段的信息。</p>
          <p><img src="https://s3.qiufengh.com/blog/1568533450392.png" alt="https://s3.qiufengh.com/blog/1568533450392.png"></p>
          <p>界面可能不是特别美观，还请见谅。</p>
          <p><img src="https://s3.qiufengh.com/blog/1568533450476.gif" alt="https://s3.qiufengh.com/blog/1568533450476.gif"></p>
          <h2 id="-">环境</h2>
          <p>node &gt;= 6.0.0</p>
          <p>redis &gt;= 2.6.0</p>
          <p>在这里我说明下，因为如果这个部署在线上环境的时候，如果每次记录都进行记录的话，会消耗大量的内存，所以我架设了一层redis，为了防止大流量的冲击，然后可以每隔一段时间进行存储。</p>
          <pre><code class="lang-javascript">const express = require(&#39;express&#39;);
const performance = require(&#39;./lib/performance.js&#39;);
const app = express();
const router = express.Router();
router.get(&#39;/&#39;, function (req, res, next) {
  req.url = &#39;./index.html&#39;;
  next();
});
app.use(router);
app.use(performance({
    time: 10, // 秒为单位
    originalDir: &#39;./originalData&#39;, // 数据的目录
    errorDir: &#39;./errorData&#39; // 报错的目录
}))
app.use(express.static(&#39;./&#39;));
const server = app.listen(3000)
</code></pre>
          <p>这里可以设置默认的时间，我这里以10秒为单位,为了demo的效果起见。一般我采用的是一分钟进行一次存储。</p>
          <p>代码地址：<a href="https://github.com/hua1995116/mcharts">https://github.com/hua1995116/mcharts</a></p>
          <p>如有好的建议以及优化的方案，还请各位在Issues上提给我。</p>
          <h1 id="-">进阶（一个利用监控平台的实战栗子）</h1>
          <p>我利用这个平台对我的一个项目进行了监控。如果你只是纯粹玩的话，还请只阅读上面的原系统地址，可以忽视我这一段，毕竟我这个系统还不够完善。</p>
          <p>线上demo：<a href="http://www.qiufengh.com/#/">http://www.qiufengh.com/#/</a></p>
          <p>监控demo：<a href="http://qiufengh.com:8080/">http://qiufengh.com:8080/</a></p>
          <p>项目: <a href="https://github.com/hua1995116/webchat/tree/monitoring">https://github.com/hua1995116/webchat/tree/monitoring</a></p>
          <p>在这里我设置了每过1分钟记录一次日志。</p>
          <pre><code class="lang-javascript">// 监控引入
app.use(performance({
    time: 60, // 秒为单位
    originalDir: &#39;./originalData&#39;, // 数据的目录
    errorDir: &#39;./errorData&#39; // 报错的目录
}))
</code></pre>
          <p>以及每隔10分钟进行一次解析。</p>
          <pre><code class="lang-javascript">function setPrase() {
    setInterval(function(){
        parseData();
      }, 1000 * 60 * 10);
}
</code></pre>
          <p><img src="https://s3.qiufengh.com/blog/1568533450395.gif" alt="https://s3.qiufengh.com/blog/1568533450395.gif"></p>
          <hr>
          <p>2017-12-20</p>
          <p>本文只是提供一个思路，如果想要专业的，可以使用<a href="https://www.elastic.co/cn/products">ELK</a>之类专业的统计分析工具。</p>

          <!-- <div class="view-cnt">（111 人已阅）</div> -->
        </div>
        <div class="my-pay">
          <div class="my-pay-btn">赞赏</div>
          <div class="my-pay-type clear">
            <div class="my-pay-alipay my-pay-div"></div>
            <div class="my-pay-weixin my-pay-div"></div>
          </div>
        </div>
        <div class="wechat-container">
          <p>欢迎关注我的公众号，秋风的笔记。</p>
          <img src="https://s3.qiufengh.com/blog/1688055012ff10bc.jpg" alt="">
        </div>
      </div>

      <div id="container"></div>
    </section>

  </div>
  <div class="blog-bottom">
    <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
  </div>
  <footer id="footer">
    <p class="small">© Copyright 2019 qiufenghua</p>
  </footer>
  <script type="text/javascript" src="/js/prism.js"></script>
  <script src="/js/axios.js"></script>
  <script src="/js/zooming.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      new Zooming({
        // options...
      }).listen('img')
    })
  </script>
  <script>
    NProgress.start();
    window.onload = function() {
      NProgress.done();
    }
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?f12dade0d0c1d020a5c06231f05b9f65";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
      var myPayBtn = document.querySelector('.my-pay-btn');
      var myPayType = document.querySelector('.my-pay-type');
      var btnShow = true;
      myPayBtn.addEventListener('click', function() {
        if (btnShow) {
          myPayType.style.display = 'block';
          btnShow = false;
        } else {
          myPayType.style.display = 'none';
          btnShow = true;
        }
      });
    })();
  </script>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
  <script>
    var gitment = new Gitment({
      id: location.href, // 可选。默认为 location.href
      owner: 'hua1995116',
      repo: 'myblog',
      oauth: {
        client_id: '814dc8bc817d0a663020',
        client_secret: 'ae232061068d5844c3665b55e34d7d5edb220113',
      },
    })
    gitment.render('container')
  </script>
</body>

</html>